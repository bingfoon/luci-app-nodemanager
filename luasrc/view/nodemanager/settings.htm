<%+header%>
<h2><%:Node Manager - Settings%></h2>

<form id="settingsForm" method="post" action="<%=luci.dispatcher.build_url('admin/services/nodemanager/settings')%>">
  <input type="hidden" name="token" value="<%=token%>"/>

  <div class="cbi-section">
    <div class="cbi-value">
      <label class="cbi-value-title"><%:Config file path%></label>
      <div class="cbi-value-field">
        <input class="cbi-input-text" name="path" value="<%=path or ''%>" placeholder="/etc/nikki/profiles/config.yaml" required/>
      </div>
    </div>

    <div class="cbi-value">
      <label class="cbi-value-title"><%:Template file path (optional)%></label>
      <div class="cbi-value-field">
        <input class="cbi-input-text" name="template" value="<%=tpl or ''%>" placeholder="/usr/share/nodemanager/config.template.yaml"/>
      </div>
    </div>

    <div class="cbi-value">
      <label class="cbi-value-title"><%:Create if missing%></label>
      <div class="cbi-value-field">
        <label><input type="checkbox" name="create" value="1"/> <%:Create target config now if it does not exist%></label>
      </div>
    </div>
  </div>

  <div>
    <button id="saveBtn" type="submit" class="cbi-button cbi-button-apply"><%:Save%></button>
  </div>
</form>

<script>
async function postForm(form) {
  const token = "<%=token%>" || "";
  const url = form.action + (token ? ("?token="+encodeURIComponent(token)) : "");
  const btn = document.getElementById('saveBtn');
  btn && (btn.disabled = true);

  try {
    const resp = await fetch(url, {
      method: 'POST',
      body: new FormData(form),
      credentials: 'same-origin',
      headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }
    });
    const text = await resp.text();
    let j;
    try { j = JSON.parse(text); }
    catch (e) { alert('Save failed: HTTP ' + resp.status + '\\n' + text.slice(0, 200)); return; }
    if (j.code === 0) location.reload();
    else alert(j.msg || 'Error');
  } catch (err) {
    alert('Network error: ' + err);
  } finally {
    btn && (btn.disabled = false);
  }
}
document.getElementById('settingsForm').addEventListener('submit', function(e){
  e.preventDefault();
  postForm(e.target);
});
</script>

<%+footer%>
