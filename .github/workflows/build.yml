name: Build luci-app-nodemanager for OpenWrt 24.10.x

on:
  workflow_dispatch:
    inputs:
      owrt_version:
        description: OpenWrt version (24.10.x)
        required: false
        default: "24.10.2"

jobs:
  build:
    strategy:
      matrix:
        target:
          #- { arch: "x86", sub: "64" }
          - { arch: "mediatek", sub: "filogic" }
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Lint Lua sources
        run: |
          sudo apt-get update
          sudo apt-get install -y lua5.1
          find luasrc -name '*.lua' -print0 | xargs -0 -n1 luac -p

      - name: Prepare
        run: |
          VER="${{ github.event.inputs.owrt_version || '24.10.0' }}"
          echo "VER=$VER" >> $GITHUB_ENV
          case "${{ matrix.target.arch }}-${{ matrix.target.sub }}" in
            x86-64)
              SDK_URL="https://downloads.openwrt.org/releases/${VER}/targets/x86/64/openwrt-sdk-${VER}-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            ;;
            mediatek-filogic)
              SDK_URL="https://downloads.openwrt.org/releases/${VER}/targets/mediatek/filogic/openwrt-sdk-${VER}-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            ;;
          esac
          echo "SDK_URL=$SDK_URL" >> $GITHUB_ENV

      - name: Download SDK
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y zstd xz-utils

          SDK_ARCHIVE="$(basename "$SDK_URL")"
          wget -q "$SDK_URL" -O "$SDK_ARCHIVE"

      - name: Extract SDK
        shell: bash
        run: |
          tar --zstd -xf openwrt-sdk-*.tar.zst
          # 只匹配已解压出的目录，不会匹配 .tar.zst
          SDK_DIR="$(ls -d openwrt-sdk-*/ | head -1 | sed 's:/$::')"
          echo "SDK_DIR=$SDK_DIR" >> "$GITHUB_ENV"

      - name: Bootstrap feeds if missing
        shell: bash
        run: |
          cd "$SDK_DIR"
          if [ ! -x scripts/feeds ]; then
            BRANCH="openwrt-$(echo "${VER:-24.10.2}" | cut -d. -f1,2)"  # 24.10.2 -> openwrt-24.10
            mkdir -p scripts
            curl -fsSL "https://raw.githubusercontent.com/openwrt/openwrt/${BRANCH}/scripts/feeds" -o scripts/feeds
            curl -fsSL "https://raw.githubusercontent.com/openwrt/openwrt/${BRANCH}/scripts/metadata.pm" -o scripts/metadata.pm
            chmod +x scripts/feeds
            echo "src-git luci https://github.com/openwrt/luci.git;openwrt-$(echo "${VER:-24.10.2}" | cut -d. -f1,2)" > feeds.conf
          fi

      - name: Prepare feeds
        shell: bash
        run: |
          cd "$SDK_DIR"
          ./scripts/feeds update -a
          ./scripts/feeds install luci luci-compat

      - name: Add package source
        shell: bash
        run: |
          cd "$SDK_DIR"
          rm -rf package/luci-app-nodemanager
          mkdir -p package/luci-app-nodemanager
          # 用 tar 流拷贝，排除 .git 和已解压的 SDK 目录
          tar -C "$GITHUB_WORKSPACE" \
              --exclude '.git' \
              --exclude 'openwrt-sdk-*' \
              -cf - . \
          | tar -C package/luci-app-nodemanager -xf -

      - name: Select packages
        shell: bash
        run: |
          cd "$SDK_DIR"
          cat >> .config <<'EOF'
          CONFIG_PACKAGE_luci-app-nodemanager=y
          CONFIG_PACKAGE_luci-i18n-nodemanager-zh-cn=y
          EOF
          make defconfig

      - name: Build luci-app-nodemanager
        shell: bash
        run: |
          cd "$SDK_DIR"
          make package/luci-app-nodemanager/{clean,compile} V=s -j"$(nproc)"
          find bin/ -name 'luci-app-nodemanager*_all.ipk' -o -name 'luci-i18n-nodemanager-*_all.ipk' -print

      - name: List build outputs
        shell: bash
        run: |
          cd "$SDK_DIR"
          find bin -maxdepth 3 -type f -name '*.ipk' -print

      - name: Upload IPKs
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-nodemanager-mediatek-filogic
          path: |
            ${{ env.SDK_DIR }}/bin/packages/*/*/luci-app-nodemanager_*.ipk
            ${{ env.SDK_DIR }}/bin/packages/*/*/luci-i18n-nodemanager-*.ipk
          if-no-files-found: warn
