name: build-luci-app-nodemanager
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        target:
          #- name: mediatek-filogic
          #  sdk: https://downloads.openwrt.org/releases/24.10.2/targets/mediatek/filogic/openwrt-sdk-24.10.2-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst
          - name: x86-64
            sdk: https://downloads.openwrt.org/releases/24.10.2/targets/x86/64/openwrt-sdk-24.10.2-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install minimal deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gawk unzip zstd rsync file curl gcc

      - name: Download & extract SDK
        run: |
          set -e
          curl -L --fail -o sdk.tar.zst "${{ matrix.target.sdk }}"
          tar -I zstd -xf sdk.tar.zst
          SDK_DIR="$(tar -I zstd -tf sdk.tar.zst | head -1 | cut -d/ -f1)"
          echo "SDK_DIR=$SDK_DIR" >> "$GITHUB_ENV"
          ln -s "$SDK_DIR" sdk

      - name: Setup feeds (luci + core/openwrt, openwrt-24.10)
        run: |
          set -e
          cd "$SDK_DIR"
          BRANCH="openwrt-24.10"
          if [ ! -x scripts/feeds ]; then
            mkdir -p scripts
            curl -fsSL "https://raw.githubusercontent.com/openwrt/openwrt/${BRANCH}/scripts/feeds" -o scripts/feeds
            curl -fsSL "https://raw.githubusercontent.com/openwrt/openwrt/${BRANCH}/scripts/metadata.pm" -o scripts/metadata.pm
            chmod +x scripts/feeds
          fi
          cat > feeds.conf <<'EOF'
          src-git luci https://github.com/openwrt/luci.git;openwrt-24.10
          src-git core https://github.com/openwrt/openwrt.git;openwrt-24.10
          EOF
          ./scripts/feeds update luci core
          ./scripts/feeds install -p luci luci-base luci-compat
          ./scripts/feeds install -p core libnl-tiny

      - name: Hard-disable lucihttp (avoid lua.h/meson/ninja)
        run: |
          set -e
          cd "$SDK_DIR"
          rm -rf feeds/luci/contrib/package/lucihttp || true

      - name: Seed .config (pre)
        run: |
          set -e
          cd "$SDK_DIR"
          cat > .config <<'EOF'
          CONFIG_ALL=n
          CONFIG_ALL_KMODS=n
          CONFIG_ALL_NONSHARED=n
          CONFIG_PACKAGE_luci-app-nodemanager=y
          CONFIG_PACKAGE_luci-i18n-nodemanager-zh-cn=y
          # disable lucihttp family
          # CONFIG_PACKAGE_liblucihttp is not set
          # CONFIG_PACKAGE_lucihttp is not set
          # CONFIG_PACKAGE_lucihttp-lua is not set
          EOF
          make defconfig

      - name: Put our package into SDK
        run: |
          set -e
          cd "$GITHUB_WORKSPACE"
          PKGROOT="$GITHUB_WORKSPACE/$SDK_DIR/package/luci-app-nodemanager"
          rm -rf "$PKGROOT"; mkdir -p "$PKGROOT"
          rsync -a --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'sdk' \
            --exclude "$SDK_DIR" \
            ./ "$PKGROOT/"

      - name: Normalize package layout (auto-fix nested dir)
        run: |
          set -e
          cd "$SDK_DIR/package"
          if [ ! -f luci-app-nodemanager/Makefile ]; then
            # 常见情形：luci-app-nodemanager/luci-app-nodemanager/Makefile
            if [ -f luci-app-nodemanager/luci-app-nodemanager/Makefile ]; then
              echo "Flatten nested luci-app-nodemanager/..."
              rsync -a luci-app-nodemanager/luci-app-nodemanager/ luci-app-nodemanager/
              rm -rf luci-app-nodemanager/luci-app-nodemanager
            else
              echo "::error::Makefile not found in package/luci-app-nodemanager"
              find luci-app-nodemanager -maxdepth 3 -type f -name 'Makefile' -print || true
              exit 1
            fi
          fi
          echo "== package tree =="
          find luci-app-nodemanager -maxdepth 2 -type f -print

      - name: Re-defconfig AFTER adding/fixing local package
        run: |
          set -e
          cd "$SDK_DIR"
          make defconfig
          if ! grep -q '^CONFIG_PACKAGE_luci-app-nodemanager=y' .config; then
            echo "::warning::CONFIG_PACKAGE_luci-app-nodemanager not present; force enable and defconfig again"
            echo 'CONFIG_PACKAGE_luci-app-nodemanager=y' >> .config
            make defconfig
          fi
          if ! grep -q '^CONFIG_PACKAGE_luci-i18n-nodemanager-zh-cn=y' .config; then
            echo 'CONFIG_PACKAGE_luci-i18n-nodemanager-zh-cn=y' >> .config
            make defconfig
          fi
          echo "== .config sanity =="
          grep -E 'CONFIG_PACKAGE_luci-(app-nodemanager|i18n-nodemanager-zh-cn)=y' .config

      - name: Build po2lmo (host tool)
        run: |
          set -e
          cd "$SDK_DIR"
          test -d feeds/luci/modules/luci-base/src || { echo "::error::luci-base src not found"; exit 1; }
          make -C feeds/luci/modules/luci-base/src clean po2lmo V=sc
          install -D -m0755 feeds/luci/modules/luci-base/src/po2lmo staging_dir/host/bin/po2lmo
          install -D -m0755 feeds/luci/modules/luci-base/src/po2lmo staging_dir/hostpkg/bin/po2lmo
          echo "PATH=$PWD/staging_dir/hostpkg/bin:$PWD/staging_dir/host/bin:$PATH" >> "$GITHUB_ENV"
          echo "PO2LMO=$PWD/staging_dir/hostpkg/bin/po2lmo" >> "$GITHUB_ENV"

      - name: Pre-build libnl-tiny (for rpcd-mod-luci headers)
        run: |
          set -e
          cd "$SDK_DIR"
          make -j"$(nproc)" V=s package/feeds/core/libnl-tiny/compile
          ls staging_dir/target-*/usr/include/libnl-tiny/netlink/msg.h >/dev/null 2>&1 || { echo "::error::libnl-tiny headers missing"; exit 1; }

      - name: Build selected packages (produce .ipk)
        run: |
          set -e
          cd "$SDK_DIR"
          export PATH="$PWD/staging_dir/hostpkg/bin:$PWD/staging_dir/host/bin:$PATH"
          export PO2LMO="${PO2LMO:-$PWD/staging_dir/hostpkg/bin/po2lmo}"
          # 只编 .config 选中的包（主包+中文i18n子包）
          make -j"$(nproc)" V=s package/compile
          make -j1 V=s package/install
          echo "::group::IPK list"
          find bin -type f -name 'luci-app-nodemanager_*.ipk' -o -name 'luci-i18n-nodemanager-zh-cn_*.ipk' -print
          echo "::endgroup::"

      - name: Collect artifacts (robust)
        run: |
          set -e
          cd "$SDK_DIR"
          OUT="$GITHUB_WORKSPACE/out/${{ matrix.target.name }}"
          mkdir -p "$OUT"
          found=0
          while IFS= read -r -d '' f; do cp -v "$f" "$OUT/"; found=1; done < <(find bin -type f -name 'luci-app-nodemanager_*.ipk' -print0)
          while IFS= read -r -d '' f; do cp -v "$f" "$OUT/"; found=1; done < <(find bin -type f -name 'luci-i18n-nodemanager-zh-cn_*.ipk' -print0)
          if [ "$found" -eq 0 ]; then
            echo "::error::No luci-app-nodemanager ipk found under bin/"
            find bin -maxdepth 5 -type f -name '*.ipk' -print
            exit 1
          fi
          ls -l "$OUT"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-nodemanager-${{ matrix.target.name }}
          path: out/${{ matrix.target.name }}
          if-no-files-found: error