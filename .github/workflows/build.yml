name: Build luci-app-nodemanager for OpenWrt 24.10.x

on:
  workflow_dispatch:
    inputs:
      owrt_version:
        description: OpenWrt version (24.10.x)
        required: false
        default: "24.10.2"

jobs:
  build:
    strategy:
      matrix:
        target:
          #- { arch: "x86", sub: "64" }
          - { arch: "mediatek", sub: "filogic" }
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Lint Lua sources
        run: |
          sudo apt-get update
          sudo apt-get install -y lua5.1
          find luasrc -name '*.lua' -print0 | xargs -0 -n1 luac -p

      - name: Prepare
        run: |
          VER="${{ github.event.inputs.owrt_version || '24.10.0' }}"
          echo "VER=$VER" >> $GITHUB_ENV
          case "${{ matrix.target.arch }}-${{ matrix.target.sub }}" in
            x86-64)
              SDK_URL="https://downloads.openwrt.org/releases/${VER}/targets/x86/64/openwrt-sdk-${VER}-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            ;;
            mediatek-filogic)
              SDK_URL="https://downloads.openwrt.org/releases/${VER}/targets/mediatek/filogic/openwrt-sdk-${VER}-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            ;;
          esac
          echo "SDK_URL=$SDK_URL" >> $GITHUB_ENV

      - name: Download SDK
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y zstd xz-utils

          SDK_ARCHIVE="$(basename "$SDK_URL")"
          wget -q "$SDK_URL" -O "$SDK_ARCHIVE"

          mkdir -p sdk
          case "$SDK_ARCHIVE" in
            *.tar.zst)
              # tar 支持 zstd 时优先用 --zstd；否则用 unzstd 管道
              if tar --help | grep -q -- '--zstd'; then
                tar --zstd -xvf "$SDK_ARCHIVE" -C sdk --strip-components=1
              else
                unzstd -c "$SDK_ARCHIVE" | tar xvf - -C sdk --strip-components=1
              fi
              ;;
            *.tar.xz)
              tar -xJf "$SDK_ARCHIVE" -C sdk --strip-components=1
              ;;
            *)
              echo "Unknown SDK archive format: $SDK_ARCHIVE"
              exit 1
              ;;
          esac

      - name: Prepare feeds (must have luci.mk)
        shell: bash
        run: |
          cd "$SDK_DIR"
          ./scripts/feeds update -a
          ./scripts/feeds install -a    # 或至少：./scripts/feeds install luci luci-compat

      - name: Add package source
        shell: bash
        run: |
          cd "$SDK_DIR"
          rm -rf package/luci-app-nodemanager
          cp -a "$GITHUB_WORKSPACE/luci-app-nodemanager" package/

      - name: Select packages
        shell: bash
        run: |
          cd "$SDK_DIR"
          cat >> .config <<'EOF'
          CONFIG_PACKAGE_luci-app-nodemanager=y
          CONFIG_PACKAGE_luci-i18n-nodemanager-zh-cn=y
          EOF
          make defconfig

      - name: Build luci-app-nodemanager
        shell: bash
        run: |
          cd "$SDK_DIR"
          make package/luci-app-nodemanager/{clean,compile} V=s
          find bin/ -name 'luci-app-nodemanager*_all.ipk' -o -name 'luci-i18n-nodemanager-*_all.ipk' -print

      - name: Upload ipk
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-nodemanager-${{ matrix.target.arch }}-${{ matrix.target.sub }}
          path: |
            sdk/bin/packages/*/*/luci-app-nodemanager_*.ipk
            sdk/bin/packages/*/*/luci-i18n-nodemanager-*.ipk