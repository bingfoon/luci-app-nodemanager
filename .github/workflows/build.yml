name: Build luci-app-nodemanager for OpenWrt 24.10.x

on:
  workflow_dispatch:
    inputs:
      owrt_version:
        description: OpenWrt version (24.10.x)
        required: false
        default: "24.10.0"

jobs:
  build:
    strategy:
      matrix:
        target:
          - { arch: "x86", sub: "64" }
          - { arch: "mediatek", sub: "filogic" }
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare
        run: |
          VER="${{ github.event.inputs.owrt_version || '24.10.0' }}"
          echo "VER=$VER" >> $GITHUB_ENV
          case "${{ matrix.target.arch }}-${{ matrix.target.sub }}" in
            x86-64)
              SDK_URL="https://downloads.openwrt.org/releases/${VER}/targets/x86/64/openwrt-sdk-${VER}-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            ;;
            mediatek-filogic)
              SDK_URL="https://downloads.openwrt.org/releases/${VER}/targets/mediatek/filogic/openwrt-sdk-${VER}-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            ;;
          esac
          echo "SDK_URL=$SDK_URL" >> $GITHUB_ENV

      - name: Download SDK
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y zstd xz-utils

          SDK_ARCHIVE="$(basename "$SDK_URL")"
          wget -q "$SDK_URL" -O "$SDK_ARCHIVE"

          mkdir -p sdk
          case "$SDK_ARCHIVE" in
            *.tar.zst)
              # tar 支持 zstd 时优先用 --zstd；否则用 unzstd 管道
              if tar --help | grep -q -- '--zstd'; then
                tar --zstd -xvf "$SDK_ARCHIVE" -C sdk --strip-components=1
              else
                unzstd -c "$SDK_ARCHIVE" | tar xvf - -C sdk --strip-components=1
              fi
              ;;
            *.tar.xz)
              tar -xJf "$SDK_ARCHIVE" -C sdk --strip-components=1
              ;;
            *)
              echo "Unknown SDK archive format: $SDK_ARCHIVE"
              exit 1
              ;;
          esac

      - name: Feed & Link package
        run: |
          pushd sdk
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          mkdir -p package/luci-app-nodemanager
          rsync -a ../ ./package/luci-app-nodemanager/ --exclude sdk --exclude .git --exclude .github
          make defconfig
          make package/luci-app-nodemanager/{clean,compile} -j$(nproc) V=s
          popd

      - name: Upload ipk
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-nodemanager-${{ matrix.target.arch }}-${{ matrix.target.sub }}
          path: |
            sdk/bin/packages/*/*/luci-app-nodemanager_*.ipk
